<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Roma 2026 | Guía PWA</title>
    
    <!-- PWA Primary Meta Tags -->
    <meta name="theme-color" content="#991B1B">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Roma 2026">
    <meta name="description" content="Guía personalizada para la escala en Roma 2026">
    
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjMqIMsVcH4cJyBPns11EXgA9GU2G_GIKn8VZZ1xZdjE0YcbKxgP9RubrKKajMFpYoXOkkaRozSncgrDKTpgqR8rEJaRg6EabSfiifPpqA2YjgZ-n1MJgFjRgbM8XFMjRfU67P3XOM3gg6fOi-ffux-i08-BgUE69iuYzbNX-eeqrjQhI6LWK9lBvwSTno/s320/ROMA%20TRAVEL.jpg">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fjord: { 50: '#fef2f2', 100: '#fee2e2', 200: '#fecaca', 300: '#fca5a5', 400: '#f87171', 500: '#ef4444', 600: '#dc2626', 700: '#b91c1c', 800: '#991b1b', 900: '#7f1d1d' },
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overscroll-behavior-y: none; background-color: #f8fafc; }
        body { font-family: 'Roboto Condensed', sans-serif; -webkit-tap-highlight-color: transparent; }
        #root { height: 100%; width: 100%; display: flex; flex-direction: column; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Custom Horizontal Scrollbar for Weather */
        .custom-h-scrollbar::-webkit-scrollbar {
            height: 6px;
        }
        .custom-h-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }
        .custom-h-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        .custom-h-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .leaflet-bottom { bottom: 85px !important; }
        
        #initial-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #991B1B; display: flex; align-items: center; justify-content: center;
            z-index: 9999; transition: opacity 0.4s ease-out;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @keyframes pulse-red {
          0% { box-shadow: 0 0 0 0 rgba(153, 27, 27, 0.7); }
          70% { box-shadow: 0 0 0 10px rgba(153, 27, 27, 0); }
          100% { box-shadow: 0 0 0 0 rgba(153, 27, 27, 0); }
        }
    </style>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.0.0",
    "react-dom/client": "https://esm.sh/react-dom@19.0.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.460.0?external=react",
    "recharts": "https://esm.sh/recharts@2.13.0?external=react",
    "leaflet": "https://esm.sh/leaflet@1.9.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="initial-loader">
        <div style="text-align: center; color: white;">
            <div style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.2); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 15px;"></div>
            <p style="font-weight: bold; letter-spacing: 1.5px; font-size: 11px; text-transform: uppercase; opacity: 0.8;">Iniciando Guía Roma</p>
        </div>
    </div>

    <div id="root"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            CalendarClock, Map as MapIcon, Wallet, BookOpen, Anchor, 
            Headphones, X, Play, Square, Navigation, CheckCircle2, 
            Circle, MapPin, AlertTriangle, Clock, ExternalLink, AlertCircle,
            Send, Volume2, Languages, PhoneCall, Thermometer, TrendingDown, Info, ArrowRight,
            Sun, Cloud, CloudRain, CloudLightning, Snowflake, Wind, Calendar, ChevronRight
        } from 'lucide-react';
        import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } from 'recharts';

        // --- CONSTANTES ---
        const SHIP_DEPARTURE_TIME = "19:00";
        const SHIP_ONBOARD_TIME = "18:30";
        const DATE_OF_VISIT = "2026-04-16";

        const COORDS = {
            CIVITAVECCHIA_DOCK: { lat: 42.097499, lng: 11.788778 },
            LARGODELAPACE: { lat: 42.096385, lng: 11.789507 },
            STAZIONE_CIVITAVECCHIA: { lat: 42.087946, lng: 11.7983 },
            TERMINI: { lat: 41.9009, lng: 12.5020 },
            COLOSSEO: { lat: 41.890246, lng: 12.492374 },
            ARCO_CONSTANTINO: { lat: 41.889756, lng: 12.490657 },
            FORI_IMPERIALI: { lat: 41.891274, lng: 12.490416 },
            CAMPIDOGLIO: { lat: 41.893317, lng: 12.48293 },
            VENEZIA: { lat: 41.8958, lng: 12.4825 },
            VITTORIANO: { lat: 41.89543, lng: 12.482704 },
            TREVI: { lat: 41.900936, lng: 12.483303 },
            PANTHEON: { lat: 41.899009, lng: 12.476792 },
            NAVONA: { lat: 41.89916, lng: 12.473091 },
            SANT_ANGELO: { lat: 41.902643, lng: 12.466393 },
            S_PIETRO: { lat: 41.902258, lng: 12.458279 },
            STAZIONE_S_PIETRO: { lat: 41.896275, lng: 12.454727 }
        };

        const GPX_WAYPOINTS = [
            { name: "COLISEO", lat: 41.890246, lng: 12.492374 },
            { name: "ARCO DE CONSTANTINO", lat: 41.889756, lng: 12.490657 },
            { name: "VISTA DEL FORO ROMANO", lat: 41.891274, lng: 12.490416 },
            { name: "ESCALERAS", lat: 41.89401, lng: 12.483923 },
            { name: "LOBA CAPITULINA", lat: 41.893287, lng: 12.483649 },
            { name: "PLAZA CAMPIDOGLIO", lat: 41.893317, lng: 12.48293 },
            { name: "COLOSO DE CONSTANTINO", lat: 41.892406, lng: 12.481458 },
            { name: "ESCALINATA VITTORIANO", lat: 41.89543, lng: 12.482704 },
            { name: "COLUMNA DE TRAJANO", lat: 41.89581, lng: 12.48427 },
            { name: "FONTANA DI TREVI", lat: 41.900936, lng: 12.483303 },
            { name: "PARTHEON", lat: 41.899009, lng: 12.476792 },
            { name: "PLAZA NAVONA", lat: 41.89916, lng: 12.473091 },
            { name: "PUENTE DE SAN ANGELO", lat: 41.901901, lng: 12.466464 },
            { name: "CASTILLO DE SAN ANGELO", lat: 41.902643, lng: 12.466393 },
            { name: "PLAZA DE SAN PEDRO", lat: 41.902258, lng: 12.458279 },
            { name: "ESTACIÓN ROMA SAN PIETRO", lat: 41.896275, lng: 12.454727 },
            { name: "METRO DE COLOSSEO", lat: 41.891277, lng: 12.491309 }
        ];

        const ROMAN_WALK_TRACK = [
            [41.891218, 12.491383], [41.891155, 12.491916], [41.891097, 12.491915], [41.891072, 12.491915], [41.890944, 12.491915], [41.890966, 12.492103], [41.890971, 12.492242], [41.890964, 12.492358], [41.890942, 12.49252], [41.890906, 12.492744], [41.890846, 12.492954], [41.890749, 12.493175], [41.890571, 12.493529], [41.890501, 12.493629], [41.890429, 12.493694], [41.890307, 12.493741], [41.89016, 12.493717], [41.889967, 12.493622], [41.889848, 12.493564], [41.889879, 12.493453], [41.889834, 12.49337], [41.889742, 12.493263], [41.889634, 12.493107], [41.889568, 12.492974], [41.889523, 12.492806], [41.889471, 12.49242], [41.889487, 12.492192], [41.889472, 12.491963], [41.88952, 12.491793], [41.889599, 12.491572], [41.889613, 12.491548], [41.889739, 12.491349], [41.889867, 12.491208], [41.890029, 12.491132], [41.890183, 12.491101], [41.890307, 12.491094], [41.890431, 12.491109], [41.89051, 12.491131], [41.890649, 12.491204], [41.890763, 12.491309], [41.890837, 12.491412], [41.890885, 12.491499], [41.890913, 12.491437], [41.890913, 12.491437], [41.890922, 12.49142], [41.89099, 12.491177], [41.891059, 12.490929], [41.891098, 12.490779], [41.891203, 12.490416], [41.891262, 12.490453], [41.891285, 12.490382], [41.891319, 12.490307], [41.891614, 12.489782], [41.89175, 12.489541], [41.891777, 12.489494], [41.892009, 12.489079], [41.892476, 12.488249], [41.892494, 12.488267], [41.892538, 12.48831], [41.892713, 12.487955], [41.892929, 12.487574], [41.892965, 12.487492], [41.892991, 12.487407], [41.893042, 12.487289], [41.893077, 12.487226], [41.893161, 12.487074], [41.893291, 12.486887], [41.89347, 12.486677], [41.893734, 12.486316], [41.893883, 12.486048], [41.894083, 12.485696], [41.894604, 12.484746], [41.894515, 12.48461], [41.894516, 12.484606], [41.894515, 12.48461], [41.894279, 12.484288], [41.894211, 12.484232], [41.894167, 12.484212], [41.894083, 12.484188], [41.894039, 12.484183], [41.894036, 12.484165], [41.894024, 12.484055], [41.894017, 12.484183], [41.89401, 12.483921], [41.893775, 12.483897], [41.89372, 12.483872], [41.893655, 12.483823], [41.893482, 12.483648], [41.893393, 12.483578], [41.893391, 12.483576], [41.893417, 12.483511], [41.893418, 12.483493], [41.893408, 12.483471], [41.893356, 12.483432], [41.893306, 12.483236], [41.893261, 12.483061], [41.893221, 12.483007], [41.893206, 12.482927], [41.893225, 12.482857], [41.89327, 12.482804], [41.893328, 12.482789], [41.89331, 12.482641], [41.893291, 12.482477], [41.893255, 12.482428], [41.893198, 12.482366], [41.893091, 12.48224], [41.892987, 12.482104], [41.892818, 12.481859], [41.892648, 12.481544], [41.892584, 12.481452], [41.892547, 12.481412], [41.892489, 12.481431], [41.892448, 12.481444], [41.892489, 12.481431], [41.892547, 12.481412], [41.892584, 12.481452], [41.892648, 12.481544], [41.892818, 12.481859], [41.892987, 12.482104], [41.893091, 12.48224], [41.893198, 12.482366], [41.893255, 12.482428], [41.893291, 12.482477], [41.89331, 12.482641], [41.893378, 12.482629], [41.893403, 12.482634], [41.89345, 12.482661], [41.893472, 12.482612], [41.893776, 12.48196], [41.89378, 12.481954], [41.893821, 12.481986], [41.893838, 12.481984], [41.893862, 12.481982], [41.893941, 12.481987], [41.893943, 12.481997], [41.894316, 12.482148], [41.894525, 12.482249], [41.894551, 12.482245], [41.894583, 12.482271], [41.894605, 12.482303], [41.894624, 12.482274], [41.894649, 12.482263], [41.894655, 12.482283], [41.894913, 12.482179], [41.894952, 12.482167], [41.894988, 12.482166], [41.895044, 12.482169], [41.895083, 12.482181], [41.895154, 12.482218], [41.895183, 12.482242], [41.895241, 12.482312], [41.895287, 12.482403], [41.8953, 12.482443], [41.895337, 12.482433], [41.895365, 12.482447], [41.895374, 12.482461], [41.895397, 12.482556], [41.895441, 12.482741], [41.895472, 12.482871], [41.895496, 12.482968], [41.895493, 12.483003], [41.89551, 12.48301], [41.895556, 12.483025], [41.895727, 12.483108], [41.895742, 12.483115], [41.895753, 12.483076], [41.895766, 12.483057], [41.895965, 12.482962], [41.895974, 12.482994], [41.895985, 12.482988], [41.896012, 12.482973], [41.896041, 12.482957], [41.896053, 12.482951], [41.896047, 12.482929], [41.896099, 12.482902], [41.896639, 12.482657], [41.896665, 12.48266], [41.896715, 12.482956], [41.89677, 12.48335], [41.896777, 12.483385], [41.896884, 12.483348], [41.897037, 12.483359], [41.897111, 12.48334], [41.897656, 12.483081], [41.898438, 12.482743], [41.89846, 12.482829], [41.898495, 12.482925], [41.898603, 12.483157], [41.898934, 12.483082], [41.899264, 12.482985], [41.899617, 12.482842], [41.900185, 12.482578], [41.900438, 12.482469], [41.900481, 12.48245], [41.900509, 12.482481], [41.900567, 12.482722], [41.900724, 12.483129], [41.900713, 12.483133], [41.900724, 12.483129], [41.900567, 12.482722], [41.900509, 12.482481], [41.900481, 12.48245], [41.900433, 12.482309], [41.900327, 12.481816], [41.900132, 12.480897], [41.900112, 12.480804], [41.900068, 12.480823], [41.900063, 12.480791], [41.900013, 12.48048], [41.899996, 12.48021], [41.899964, 12.479825], [41.899964, 12.479789], [41.899983, 12.479603], [41.899968, 12.47919], [41.89988, 12.478975], [41.899791, 12.4788], [41.899734, 12.478716], [41.899684, 12.478747], [41.89964, 12.478593], [41.899568, 12.478446], [41.899538, 12.478399], [41.899526, 12.478355], [41.899459, 12.477985], [41.899356, 12.477287], [41.899305, 12.477145], [41.899154, 12.477036], [41.899149, 12.47692], [41.899142, 12.476805], [41.899141, 12.47678], [41.899133, 12.476635], [41.899439, 12.476602], [41.899522, 12.476592], [41.899523, 12.476505], [41.89952, 12.476439], [41.899403, 12.47512], [41.899398, 12.475029], [41.899395, 12.474837], [41.899394, 12.474063], [41.899393, 12.474049], [41.899393, 12.474014], [41.899392, 12.473993], [41.899387, 12.473856], [41.899385, 12.473791], [41.899384, 12.473779], [41.899142, 12.473804], [41.899123, 12.473395], [41.899117, 12.473313], [41.899112, 12.47325], [41.899172, 12.473037], [41.899209, 12.47291], [41.899206, 12.472847], [41.899811, 12.472797], [41.899805, 12.472696], [41.899803, 12.472246], [41.899829, 12.472245], [41.899953, 12.47225], [41.899983, 12.472183], [41.900078, 12.47214], [41.900229, 12.472126], [41.900453, 12.472128], [41.900462, 12.472084], [41.900469, 12.471939], [41.900477, 12.471738], [41.900478, 12.471615], [41.900474, 12.471325], [41.900477, 12.470922], [41.900476, 12.470898], [41.900477, 12.470845], [41.900481, 12.470659], [41.900481, 12.470625], [41.900478, 12.470198], [41.900486, 12.469834], [41.900504, 12.469499], [41.900508, 12.469427], [41.900527, 12.469011], [41.900527, 12.468988], [41.900527, 12.468963], [41.900538, 12.468503], [41.900535, 12.468172], [41.900548, 12.467653], [41.900554, 12.467504], [41.900555, 12.467415], [41.900555, 12.467373], [41.900701, 12.467216], [41.900738, 12.467178], [41.90113, 12.466787], [41.901134, 12.466717], [41.901123, 12.466573], [41.901121, 12.466521], [41.901212, 12.466521], [41.901234, 12.466519], [41.898491, 12.454882], [41.898478, 12.454813], [41.897927, 12.455007], [41.897891, 12.454929], [41.897841, 12.454815], [41.897562, 12.454195], [41.897455, 12.453956], [41.897429, 12.453897], [41.896645, 12.454792], [41.896596, 12.454715], [41.896554, 12.454656], [41.896523, 12.454637], [41.896495, 12.454634], [41.896473, 12.454641], [41.896433, 12.454677], [41.896394, 12.454618], [41.89629, 12.454744]
        ];

        const COLISEO_AUDIO_TEXT = `¡Bienvenido a Roma! Soy tu guía personal y es un placer acompañarte hoy. Estás frente a la mayor obra de ingeniería de la Antigüedad: el Anfiteatro Flavio, aunque el mundo entero lo conoce como el Coliseo.

Para esta experiencia, te propongo un recorrido circular por su exterior. Empezaremos en el lado norte (frente a la entrada principal actual) y caminaremos en el sentido de las agujas del reloj.

1. La Fachada Norte: El Esplendor Original
Mira hacia arriba: aquí puedes ver las cuatro alturas originales con sus diferentes estilos de columnas (dórico, jónico y corintio).

2. El Sector Este: El Camino del Gladiador
Aquí verás los restos del Ludus Magnus, la escuela de gladiadores. Existía un túnel que los conectaba directamente con la arena del Coliseo.

3. El Sector Sur: Las Cicatrices de la Historia
El anillo exterior desapareció en el terremoto de 1349. Durante siglos, este lugar fue una "cantera" para construir palacios y la propia Basílica de San Pedro.

4. El Sector Oeste y el Arco de Constantino
Terminamos frente al Arco de Constantino. Imagina el rugido de 50.000 espectadores y el olor a incienso de las procesiones imperiales.`;

        const ARCO_CONSTANTINO_AUDIO_TEXT = `¡Bienvenido al Arco de Constantino! 

1. El Monumento a la Victoria
Estás ante el arco del triunfo más grande y mejor conservado de Roma. Fue erigido en el año 315 d.C. para conmemorar algo que cambió la historia del mundo: la victoria de Constantino sobre su rival Majencio en la Batalla del Puente Milvio.

Dato de experto: Esta batalla es famosa porque, según la leyenda, Constantino tuvo una visión de una cruz en el cielo con las palabras "In hoc signo vinces" (Con este signo vencerás). Fue el primer paso hacia la cristianización del Imperio Romano.

2. Un "Frankenstein" de la Antigüedad
Acércate un poco más. Si te fijas bien en los relieves y las estatuas, notarás que algunos estilos artísticos parecen diferentes a otros. No es tu imaginación.

Este arco es lo que los arqueólogos llaman un monumento de "spolia". En lugar de crear todo de cero, los constructores "reciclaron" piezas de monumentos de los tres mejores emperadores del pasado: Trajano, Adriano y Marco Aurelio.

¿Por qué lo hicieron? No fue por falta de dinero, sino por propaganda política. Constantino quería decir: "Soy tan grande como los mejores emperadores de la historia dorada de Roma".

3. Guía visual de las piezas recicladas
Mira hacia las diferentes alturas del arco:

Las estatuas de los prisioneros (arriba): Esas figuras de guerreros con barba que están en la parte superior pertenecen a la época de Trajano. Representan a los dacios derrotados.

Los medallones circulares: Los que ves sobre los arcos laterales son de la época de Adriano. Si te fijas bien, muestran escenas de caza y sacrificios a dioses paganos.

Los paneles cuadrados (en el ático): Los relieves más altos pertenecen a la época de Marco Aurelio. Muestran al emperador distribuyendo dinero al pueblo y en escenas de guerra.

4. La inscripción central
Si miras el gran bloque de texto en la parte superior central, verás letras talladas profundamente. En una parte dice que Constantino venció a su tirano "instinctu divinitatis" (por inspiración divina).

Es una frase muy ambigua. No menciona a Cristo, pero tampoco a los dioses paganos. Constantino estaba jugando a dos bandas mientras el Imperio cambiaba de fe.

5. El Camino de los Triunfos
Para terminar, mira el suelo que rodea el arco. Por aquí pasaba la Vía Triumphalis. Imagina el estruendo de los carros, los soldados desfilando con el botín de guerra y los cautivos encadenados pasando bajo estos tres arcos hacia el Foro Romano.

Es el lugar exacto donde la gloria militar se convertía en leyenda eterna.`;

        const LOBA_CAPITULINA_AUDIO_TEXT = `¡Bienvenido a la Loba Capitolina!

1. El Símbolo de la Eternidad
Mira la silueta de bronce recortada contra el cielo romano. Esta loba, conocida como Luperca, es mucho más que una estatua; es el emblema de la ciudad. Verás a una loba alerta, con las orejas tiesas y la mirada fija, mientras protege a dos bebés que se alimentan de ella.

Dato de experto: Lo que ves aquí es una réplica exacta. La loba original, de bronce fundido, se custodia a pocos metros de donde estás, dentro de los Museos Capitolinos. Durante siglos se creyó que era una obra etrusca del siglo V a.C., aunque estudios recientes de carbono-14 sugieren que el cuerpo de la loba podría ser de la Edad Media.

2. La Leyenda de la Fundación
Cierra los ojos un momento e imagina el río Tíber hace 2.800 años. La leyenda cuenta que el dios Marte dejó embarazada a una vestal llamada Rea Silvia. Sus hijos gemelos, Rómulo y Remo, fueron arrojados al río en una cesta para evitar que fueran asesinados por su tío, el rey Amulio.

La cesta quedó varada en la orilla, a los pies de esta misma colina, y fue allí donde la loba los encontró. En lugar de devorarlos, los amamantó como si fueran sus propios cachorros hasta que un pastor los rescató.

Los Gemelos: Si te fijas bien, los bebés tienen un estilo artístico diferente al de la loba. Eso es porque fueron añadidos mucho después, a finales del siglo XV, por el artista renacentista Antonio del Pollaiolo.

3. SPQR: El rastro de la Loba
Si miras a tu alrededor, verás las siglas S.P.Q.R. (Senatus Populusque Romanus). La loba es la madre de ese pueblo. Para los antiguos romanos, descender de una fiera y de un dios (Marte) era la justificación perfecta para su destino de conquistar el mundo.

4. El "Mirador Secreto"
Ahora, haz un giro de 180 grados y dale la espalda a la loba. Lo que tienes frente a ti es, posiblemente, la mejor vista gratuita de Roma.

Desde este balcón natural, tienes el Foro Romano a tus pies. Puedes ver el Arco de Septimio Severo a la izquierda, las columnas del Templo de Saturno y, al fondo, la silueta del Coliseo de donde venimos caminando. Es el lugar donde el mito (la loba) se encuentra con la realidad histórica (las ruinas).`;

        const INITIAL_ITINERARY = [
            { id: '1', title: 'Llegada a Puerto', startTime: '07:00', endTime: '07:00', locationName: 'Muelle Civitavecchia', coords: COORDS.CIVITAVECCHIA_DOCK, description: 'Logística: El barco atraca en el muelle de Civitavecchia. Sé de los primeros en la cubierta 0 para evitar las colas masivas de desembarque.', keyDetails: 'Civitavecchia fue el puerto histórico de Roma desde el siglo II (fundado por Trajano como Centumcellae).', priceEUR: 0, type: 'logistics', completed: false },
            { id: '2', title: 'Shuttle a Largo della Pace', startTime: '07:15', endTime: '07:40', locationName: 'Muelle', endLocationName: 'Largo della Pace', coords: COORDS.CIVITAVECCHIA_DOCK, endCoords: COORDS.LARGODELAPACE, description: 'Logística: Toma el Shuttle Bus gratuito. Te dejará en el centro de servicios de Largo della Pace.', keyDetails: 'Consejo: Ten a mano tus documentos de identidad y tarjeta del crucero.', priceEUR: 0, type: 'transport', completed: false },
            { id: '3', title: 'Bus a la Estación', startTime: '08:09', endTime: '08:16', locationName: 'Largo della Pace', endLocationName: 'Estación FFCC', coords: COORDS.LARGODELAPACE, endCoords: COORDS.STAZIONE_CIVITAVECCHIA, description: 'Logística: Toma el bus urbano local hacia la estación.', keyDetails: 'Al ser tan temprano, PREGUNTAR DONDE COMPRAR EL BILLETE PARA EL BUS (normalmente se compran en estancos, kioscos o en Bar de la Estación Largo della Pace), Y SI NO, INTENTAR PAGARLO AL CONDUCTOR', priceEUR: 2, type: 'transport', completed: false, notes: 'CRITICAL', googleMapsUrl: 'https://maps.app.goo.gl/6HVPmd9PuhR8zmbo7', contingencyNote: 'Si el bus se retrasa coger un taxi a la Estación de tren (10 euros)' },
            { id: '4', title: 'Tren a Roma Termini', startTime: '08:36', endTime: '09:48', locationName: 'Civitavecchia', endLocationName: 'Roma Termini', coords: COORDS.STAZIONE_CIVITAVECCHIA, endCoords: COORDS.TERMINI, description: 'Logística: El tren regional te lleva al corazón de la ciudad de Roma.', keyDetails: '¡Crítico!: compra el ticket BIRG / No olvides poner tú nombre y fecha además de validar el ticket en las máquinas amarillas/verdes antes de subir al tren para evitar multas. Vista Escénica: Siéntate a la derecha para ver el mar Tirreno durante los primeros 20 minutos.', priceEUR: 12, type: 'transport', completed: false, googleMapsUrl: 'https://maps.app.goo.gl/mbpGQtrYJUdwxoMy6', contingencyNote: "Si pierdes este tren, el siguiente es a las 08:58 (Pérdida de visita: 22 min)." },
            { id: '5', title: 'Metro al Coliseo', startTime: '10:00', endTime: '10:10', locationName: 'Roma Termini', endLocationName: 'Colosseo', coords: COORDS.TERMINI, endCoords: COORDS.COLOSSEO, description: 'Logística: En Termini, sigue las señales de la Línea B (Azul) hacia Laurentina y baja en la segunda parada: "Colosseo".', keyDetails: 'La estación de metro está construida literalmente sobre cimientos romanos.', priceEUR: 0, type: 'transport', completed: false, googleMapsUrl: 'https://maps.app.goo.gl/G1ET9y2tqhpmqtNU9' },
            { id: '6', title: 'Coliseo', startTime: '10:10', endTime: '10:30', locationName: 'Colosseo', coords: COORDS.COLOSSEO, description: 'Dato Histórico: El Anfiteatro Flavio es la arena más grande del mundo antiguo. Podía albergar a 50,000 espectadores.', keyDetails: 'Foto: La colina de Via Nicola Salvi ofrece una vista elevada perfecta para capturar el monumento.', priceEUR: 0, type: 'sightseeing', completed: false, audioGuideText: COLISEO_AUDIO_TEXT },
            { id: '7', title: 'Arco de Constantino', startTime: '10:30', endTime: '10:55', locationName: 'Arco di Costantino', coords: COORDS.ARCO_CONSTANTINO, description: 'Dato Histórico: Erigido en el 315 d.C. para celebrar la victoria en la batalla del Puente Milvio.', keyDetails: 'Es un "museo al aire libre" porque utiliza relieves reciclados de otros monumentos (técnica "spolia").', priceEUR: 0, type: 'sightseeing', completed: false, audioGuideText: ARCO_CONSTANTINO_AUDIO_TEXT },
            { id: '8', title: 'Via dei Fori Imperiali (Tramo I)', startTime: '10:55', endTime: '11:10', locationName: 'Via dei Fori Imperiali', coords: COORDS.FORI_IMPERIALI, description: 'Esta avenida fue trazada por Mussolini. A la izquierda verás los Foros de Augusto y Nerva.', keyDetails: 'Mira hacia abajo para ver los mapas de mármol que muestran la expansión del Imperio Romano.', priceEUR: 0, type: 'sightseeing', completed: false },
            { id: '9', title: 'Via dei Fori Imperiali (Tramo II)', startTime: '11:10', endTime: '11:20', locationName: 'Via dei Fori Imperiali', coords: COORDS.FORI_IMPERIALI, description: 'Al final de la calle verás el Foro de Trajano con su famosa columna de 30 metros de altura.', keyDetails: 'La columna narra las guerras contra los dacios en un bajorrelieve en espiral único.', priceEUR: 0, type: 'sightseeing', completed: false },
            { id: '10', title: 'Loba Capitolina', startTime: '11:20', endTime: '11:30', locationName: 'Campidoglio', coords: COORDS.CAMPIDOGLIO, description: 'Dato Histórico: La Lupa Capitolina amamantando a Rómulo y Remo es el símbolo de la fundación de la ciudad (753 a.C.).', keyDetails: 'La que verás en la calle es una copia; la original de bronce está en los Museos Capitolinos.', priceEUR: 0, type: 'sightseeing', completed: false, audioGuideText: LOBA_CAPITULINA_AUDIO_TEXT },
            { id: '11', title: 'Plaza del Campidoglio', startTime: '11:30', endTime: '11:40', locationName: 'Piazza del Campidoglio', coords: COORDS.CAMPIDOGLIO, description: 'Dato Artístico: Diseñada por Miguel Ángel en el siglo XVI. Fíjate en el diseño geométrico del suelo.', keyDetails: 'La estatua ecuestre de Marco Aurelio en el centro es una copia fiel de la original.', priceEUR: 0, type: 'sightseeing', completed: false },
            { id: '12', title: 'Coloso de Constantino', startTime: '11:40', endTime: '11:50', locationName: 'Museos Capitolinos', coords: COORDS.CAMPIDOGLIO, description: 'Dato Histórico: En el patio de los museos (visible desde fuera) están los restos de una estatua de 12 metros.', keyDetails: 'Solo su cabeza mide 2.6 metros de altura.', priceEUR: 0, type: 'sightseeing', completed: false },
            { id: '13', title: 'Monumento a Víctor Manuel II', startTime: '11:50', endTime: '12:00', locationName: 'Piazza Venezia', coords: COORDS.VITTORIANO, description: 'Curiosidad: Conocido por los romanos como "La Máquina de Escribir" o "La Tarta de Bodas".', keyDetails: 'Alberga la tumba del Soldado Desconocido y ofrece de las mejores vistas de la ciudad.', priceEUR: 0, type: 'sightseeing', completed: false },
            { id: '14', title: 'Fontana di Trevi', startTime: '12:00', endTime: '12:45', locationName: 'Fontana di Trevi', coords: COORDS.TREVI, description: 'Leyenda: Lanza una moneda de espaldas con la mano derecha sobre el hombro izquierdo para asegurar tu regreso.', keyDetails: 'Normativa: Sé respetuoso; está prohibido sentarse en el mármol o comer cerca del agua.', priceEUR: 2, type: 'sightseeing', completed: false },
            { id: '15', title: 'Panteón', startTime: '12:45', endTime: '12:55', locationName: 'Piazza della Rotonda', coords: COORDS.PANTHEON, description: 'Dato de Ingeniería: El templo de todos los dioses tiene la cúpula de hormigón no armado más grande del mundo.', keyDetails: 'El óculo central de 9 metros es la única fuente de luz y deja entrar la lluvia.', priceEUR: 0, type: 'sightseeing', completed: false },
            { id: '16', title: 'Plaza Navona', startTime: '12:55', endTime: '13:10', locationName: 'Piazza Navona', coords: COORDS.NAVONA, description: 'Dato Histórico: Tiene forma ovalada porque se construyó sobre el antiguo Estadio de Domiciano.', keyDetails: 'No te pierdas la Fuente de los Cuatro Ríos de Bernini con sus gigantes continentes.', priceEUR: 0, type: 'sightseeing', completed: false },
            { id: '17', title: 'Puente de Sant\'Angelo', startTime: '13:10', endTime: '13:30', locationName: 'Ponte Sant\'Angelo', coords: COORDS.SANT_ANGELO, description: 'Dato Artístico: Cruzarás el Tíber escoltado por diez ángeles diseñados por Bernini.', keyDetails: 'Cada ángel sostiene un instrumento de la Pasión de Cristo (cruz, clavos, etc).', priceEUR: 0, type: 'sightseeing', completed: false },
            { id: '18', title: 'Castillo Sant\'Angelo', startTime: '13:30', endTime: '13:45', locationName: 'Castel Sant\'Angelo', coords: COORDS.SANT_ANGELO, description: 'Dato Histórico: Originalmente mausoleo de Adriano, luego se convirtió en fortaleza papal.', keyDetails: 'Existe un pasillo secreto (Passetto di Borgo) que lo conecta con el Vaticano.', priceEUR: 0, type: 'sightseeing', completed: false },
            { id: '19', title: 'Plaza de San Pedro del Vaticano', startTime: '13:45', endTime: '14:10', locationName: 'San Pietro', coords: COORDS.S_PIETRO, description: 'Dato de Guía: Estás en el estado más pequeño del mundo. Observa la columnata de Bernini.', keyDetails: 'La plaza fue diseñada como dos brazos que "abrazan" a los fieles. Obelisco de Egipto.', priceEUR: 0, type: 'sightseeing', completed: false },
            { id: '20', title: 'Regreso a Estación Roma S. Pietro', startTime: '14:10', endTime: '14:40', locationName: 'Vaticano -> Estación', endLocationName: 'Estación S. Pietro', coords: COORDS.S_PIETRO, endCoords: COORDS.STAZIONE_S_PIETRO, description: 'Ruta: Camina por la Via della Conciliazione y gira hacia el sur.', keyDetails: 'Esta estación es mucho más cercana al Vaticano que Termini, lo que te ahorra tiempo.', priceEUR: 0, type: 'logistics', completed: false, googleMapsUrl: 'https://maps.app.goo.gl/QAccEJfTLABUsKw18' },
            { id: '21', title: 'Tren de Regreso a Civitavecchia', startTime: '15:02', endTime: '16:02', locationName: 'Roma S. Pietro', endLocationName: 'Civitavecchia', coords: COORDS.STAZIONE_S_PIETRO, endCoords: COORDS.STAZIONE_CIVITAVECCHIA, description: 'Tu ticket BIRG sigue siendo válido para este trayecto de vuelta.', keyDetails: 'Busca del ANDÉN en que parara tú tren.', priceEUR: 0, type: 'transport', completed: false, notes: 'CRITICAL', googleMapsUrl: 'https://maps.app.goo.gl/QQEwFSMoUECk4nw77', contingencyNote: '¡Vital!: El tren de las 15:02 es tu garantía para llegar a tiempo. Si hay retrasos, el de las 15:35 es la última opción.' },
            { id: '22', title: 'Bus Estación a Shuttle del Barco', startTime: '16:10', endTime: '16:20', locationName: 'Estación Civitavecchia', endLocationName: 'Largo della Pace', coords: COORDS.STAZIONE_CIVITAVECCHIA, endCoords: COORDS.LARGODELAPACE, description: 'Logística: Al salir de la estación de Civitavecchia, busca el bus naranja/urbano que lleva de regreso.', keyDetails: 'Compra en el kiosco de la Estación el ticket del bus', priceEUR: 2, type: 'transport', completed: false, googleMapsUrl: 'https://maps.app.goo.gl/XiTcZfmdwj9p4ydo9' },
            { id: '23', title: 'Shuttle al Barco', startTime: '16:30', endTime: '16:50', locationName: 'Largo della Pace', endLocationName: 'Muelle Barco', coords: COORDS.LARGODELAPACE, endCoords: COORDS.CIVITAVECCHIA_DOCK, description: 'Logística: Desde el hub de Largo della Pace, busca el bus con el logo o nombre de tu crucero.', keyDetails: 'Este es el trayecto final directo al muelle de atraque.', priceEUR: 0, type: 'transport', completed: false },
            { id: '24', title: 'Hora Límite de Embarque', startTime: '18:30', endTime: '18:30', locationName: 'Muelle Crucero', coords: COORDS.CIVITAVECCHIA_DOCK, description: 'Aviso: Debes estar escaneando tu tarjeta para entrar al barco ahora.', keyDetails: 'Las pasarelas se retiran poco después de esta hora. ¡No te retrases!', priceEUR: 0, type: 'logistics', completed: false, notes: 'CRITICAL' },
            { id: '25', title: 'Salida de Puerto', startTime: '19:00', endTime: '19:00', locationName: 'Civitavecchia', coords: COORDS.CIVITAVECCHIA_DOCK, description: 'Despedida: El barco zarpa hacia el próximo destino. Es el momento perfecto para subir a cubierta.', keyDetails: 'Mira el atardecer sobre Civitavecchia mientras Roma queda atrás.', priceEUR: 0, type: 'logistics', completed: false }
        ];

        const PRONUNCIATIONS = [
            { word: 'Buongiorno', phonetic: "Bwon-jor-no", simplified: 'Bwon-yor-no', meaning: 'Buenos días' },
            { word: 'Buonasera', phonetic: "Bwo-na-se-ra", simplified: 'Bwona-sera', meaning: 'Buenas tardes/noches' },
            { word: 'Ciao', phonetic: "Chao", simplified: 'Chao', meaning: 'Hola / Adiós' },
            { word: 'Grazie', phonetic: "Grat-zye", simplified: 'Grat-sie', meaning: 'Gracias' },
            { word: 'Prego', phonetic: "Pre-go", simplified: 'Pre-go', meaning: 'De nada / Pase' },
            { word: 'Per favore', phonetic: "Per fa-vo-re", simplified: 'Per fa-vo-re', meaning: 'Por favor' },
            { word: 'Scusi', phonetic: "Sku-zee", simplified: 'Escusi', meaning: 'Disculpe / Perdón' },
            { word: 'Quanto costa?', phonetic: "Kwan-to kos-ta", simplified: 'Kwan-to kos-ta', meaning: '¿Cuánto cuesta?' },
            { word: 'Dov\'è il bagno?', phonetic: "Do-ve il ba-nyo", simplified: 'Dové il bagno', meaning: '¿Dónde está el baño?' },
            { word: 'Il conto, per favore', phonetic: "Il kon-to, per fa-vo-re", simplified: 'Il conto, por favor', meaning: 'La cuenta, por favor' },
            { word: 'Parla spagnolo?', phonetic: "Par-la spa-nyo-lo", simplified: 'Parla spañolo', meaning: '¿Habla español?' },
            { word: 'Non capisco', phonetic: "Non ka-pee-sko", simplified: 'Non capisco', meaning: 'No entiendo' },
            { word: 'Un caffè, per favore', phonetic: "Oon ka-fe, per fa-vo-re", simplified: 'Un café, por favor', meaning: 'Un café, por favor' },
            { word: 'Dov\'è la stazione?', phonetic: "Do-ve la stat-zyo-ne", simplified: 'Dové la statsione', meaning: '¿Dónde está la estación?' },
            { word: 'A destra / A sinistra', phonetic: "A des-tra / A see-nees-tra", simplified: 'A destra / A sinistra', meaning: 'A la derecha / A la izquierda' },
            { word: 'Sì / No', phonetic: "See / No", simplified: 'Si / No', meaning: 'Sí / No' },
            { word: 'Aiuto!', phonetic: "A-yoo-to", simplified: 'Ayuto', meaning: '¡Ayuda!' },
            { word: 'Arrivederci', phonetic: "A-ree-ve-der-chi", simplified: 'Arivederchi', meaning: 'Adiós (formal)' },
            { word: 'Vorrei un gelato', phonetic: "Vor-ray oon je-la-to", simplified: 'Vorrei un yelato', meaning: 'Quisiera un helado' },
            { word: 'Dov\'è la farmacia?', phonetic: "Do-ve la far-ma-chee-a", simplified: 'Dové la farmachia', meaning: '¿Dónde está la farmacia?' }
        ];

        // --- UTILIDADES ---
        const formatMinutes = (mins) => {
          const h = Math.floor(mins / 60);
          const m = mins % 60;
          if (h > 0 && m > 0) return `${h}h ${m}min`;
          if (h > 0) return `${h}h`;
          return `${m}min`;
        };

        const calculateDuration = (startStr, endStr) => {
          const [startH, startM] = startStr.split(':').map(Number);
          const [endH, endM] = endStr.split(':').map(Number);
          let diffMins = (endH * 60 + endM) - (startH * 60 + startM);
          if (diffMins < 0) diffMins += 24 * 60; 
          const hours = Math.floor(diffMins / 60);
          const minutes = diffMins % 60;
          if (hours > 0 && minutes > 0) return `${hours}h ${minutes}m`;
          if (hours > 0) return `${hours}h`;
          return `${minutes} min`;
        };

        const calculateTimeProgress = (startTime, endTime) => {
          const now = new Date();
          const currentMinutes = now.getHours() * 60 + now.getMinutes();
          const [startH, startM] = startTime.split(':').map(Number);
          const startMinutes = startH * 60 + startM;
          const [endH, endM] = endTime.split(':').map(Number);
          const endMinutes = endH * 60 + endM;
          if (currentMinutes < startMinutes) return 0;
          if (currentMinutes >= endMinutes) return 100;
          const totalRange = endMinutes - startMinutes;
          const elapsed = currentMinutes - startMinutes;
          return Math.min(100, Math.max(0, (elapsed / totalRange) * 100));
        };

        // --- COMPONENTES ---

        const Timeline = ({ itinerary, onToggleComplete, onLocate, userLocation, onOpenAudioGuide }) => {
          const [, setTick] = useState(0);
          useEffect(() => {
            const timer = setInterval(() => setTick(t => t + 1), 60000);
            return () => clearInterval(timer);
          }, []);

          const calculateGap = (endStrPrev, startStrNext) => {
            const [endH, endM] = endStrPrev.split(':').map(Number);
            const [startH, startM] = startStrNext.split(':').map(Number);
            return (startH * 60 + startM) - (endH * 60 + endM);
          };

          return (
            <div className="pb-24 px-4 pt-4 max-w-lg mx-auto">
              <div className="flex justify-between items-end mb-6">
                <h2 className="text-2xl font-bold text-red-800 uppercase tracking-tight">Itinerario Roma</h2>
                <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest bg-slate-100 px-2 py-1 rounded-md">Sync</span>
              </div>
              <div className="relative border-l-2 border-slate-200 ml-3 space-y-8">
                {itinerary.map((act, idx) => {
                  const prevAct = idx > 0 ? itinerary[idx - 1] : null;
                  const gap = prevAct ? calculateGap(prevAct.endTime, act.startTime) : 0;
                  const actProgress = calculateTimeProgress(act.startTime, act.endTime);
                  const gapProgress = prevAct ? calculateTimeProgress(prevAct.endTime, act.startTime) : 0;
                  
                  return (
                    <React.Fragment key={act.id}>
                      {gap > 0 && (
                        <div className="relative ml-0 my-8">
                            <div className="absolute left-[-2px] top-[-20px] bottom-[-20px] border-l-2 border-dashed border-slate-300"></div>
                            <div className="ml-6 flex items-center">
                                <div className="bg-white/80 backdrop-blur-sm px-4 py-3 rounded-2xl border border-slate-100 flex flex-col shadow-sm w-full max-w-[240px]">
                                    <div className="flex items-center mb-2">
                                        <div className="bg-slate-100 p-1.5 rounded-full mr-3 border border-slate-200"><Clock size={12} className="text-slate-600" /></div>
                                        <div className="flex flex-col">
                                            <span className="text-[9px] font-black text-slate-400 uppercase leading-none mb-1">Intervalo</span>
                                            <span className="text-[10px] font-bold text-slate-600 uppercase">{formatMinutes(gap)} — {gap > 30 ? 'Libre' : 'Traslado'}</span>
                                        </div>
                                    </div>
                                    <div className="w-full h-1 bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-slate-400" style={{ width: `${gapProgress}%` }}></div></div>
                                </div>
                            </div>
                        </div>
                      )}
                      <div className="mb-8 ml-6 relative">
                        <div onClick={() => onToggleComplete(act.id)} className={`absolute -left-[31px] top-0 rounded-full bg-white border-2 cursor-pointer z-10 ${act.completed ? 'border-emerald-500 text-emerald-500 shadow-sm' : 'border-red-600 text-red-600 shadow-sm'}`}>
                            {act.completed ? <CheckCircle2 size={24} /> : <Circle size={24} />}
                        </div>
                        <div className={`rounded-2xl border shadow-sm transition-all overflow-hidden bg-white ${act.notes === 'CRITICAL' ? 'border-red-500 bg-red-50' : act.completed ? 'opacity-70 border-emerald-500' : 'border-slate-100'}`}>
                            <div className="w-full h-1.5 bg-slate-50 overflow-hidden"><div className={`h-full ${actProgress === 100 ? 'bg-slate-300' : 'bg-red-600'}`} style={{ width: `${actProgress}%` }}></div></div>
                            <div className="p-5">
                                <div className="flex justify-between items-start mb-2">
                                  <div>
                                    <div className="flex items-center space-x-2 mb-2">
                                        <span className="px-2 py-0.5 rounded text-[10px] font-bold bg-red-100 text-red-800">{act.startTime} - {act.endTime}</span>
                                        <span className="px-2 py-0.5 rounded text-[10px] font-medium bg-slate-100 text-slate-600">{calculateDuration(act.startTime, act.endTime)}</span>
                                    </div>
                                    <h3 className="font-bold text-lg text-gray-800 leading-tight">{act.title}</h3>
                                  </div>
                                  {act.notes === 'CRITICAL' && <AlertTriangle className="text-red-500 animate-pulse" size={20} />}
                                </div>
                                <div className="mb-3 text-sm text-gray-600 flex items-center flex-wrap gap-1"><MapPin size={14} className="mr-0.5 text-red-500"/> {act.locationName}</div>
                                <p className="text-sm text-gray-600 mb-4 whitespace-pre-line leading-relaxed">{act.description}</p>
                                <div className="bg-slate-50 p-3 rounded-xl text-sm italic border-l-4 border-red-500 mb-4 shadow-inner text-slate-700 font-medium">"{act.keyDetails}"</div>
                                {act.contingencyNote && <div className="bg-amber-100 border-2 border-amber-400 rounded-2xl p-4 my-4 flex items-start gap-3 shadow-md animate-pulse"><AlertCircle className="text-amber-700 flex-shrink-0 mt-1" size={20} /><div><p className="text-[11px] font-black text-amber-900 uppercase tracking-tighter mb-1">⚠️ PLAN DE CONTINGENCIA</p><p className="text-xs text-amber-950 font-bold leading-snug">{act.contingencyNote}</p></div></div>}
                                <div className="flex flex-wrap items-center gap-2 mt-3 pt-4 border-t border-slate-50">
                                    <button onClick={() => onLocate(act.coords)} className="flex items-center text-[10px] font-bold text-red-700 bg-red-50 px-3 py-2 rounded-xl border border-red-100 shadow-sm"><Navigation size={12} className="mr-1.5" /> UBICACIÓN</button>
                                    {act.audioGuideText && <button onClick={() => onOpenAudioGuide(act)} className="flex items-center text-[10px] font-bold text-white bg-red-800 px-3 py-2 rounded-xl shadow-md"><Headphones size={12} className="mr-1.5" /> AUDIOGUÍA</button>}
                                    {act.googleMapsUrl && <a href={act.googleMapsUrl} target="_blank" className="flex items-center text-[10px] font-bold text-white bg-emerald-600 px-3 py-2 rounded-xl"><ExternalLink size={12} className="mr-1.5" /> GOOGLE MAPS</a>}
                                    <button onClick={() => onToggleComplete(act.id)} className={`ml-auto px-3 py-2 rounded-xl text-[10px] font-bold uppercase transition-all ${act.completed ? 'bg-emerald-100 text-emerald-700' : 'bg-red-800 text-white'}`}>{act.completed ? 'Hecho' : 'Check'}</button>
                                </div>
                            </div>
                        </div>
                      </div>
                    </React.Fragment>
                  );
                })}
              </div>
            </div>
          );
        };

        const MapComponent = ({ activities, userLocation, focusedLocation }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const layersRef = useRef([]);

            useEffect(() => {
                if (!mapContainerRef.current || mapInstanceRef.current) return;
                const map = L.map(mapContainerRef.current, { zoomControl: false }).setView([41.8902, 12.4922], 14);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
                mapInstanceRef.current = map;
                return () => { map.remove(); mapInstanceRef.current = null; };
            }, []);

            useEffect(() => {
                const map = mapInstanceRef.current;
                if (!map) return;
                layersRef.current.forEach(layer => layer.remove());
                layersRef.current = [];

                activities.forEach(act => {
                    const marker = L.marker([act.coords.lat, act.coords.lng]).addTo(map);
                    marker.bindPopup(`<div style="padding:10px;"><h3 style="margin:0;font-size:14px;color:#991B1B;">${act.title}</h3><p style="margin:5px 0 0;font-size:11px;">${act.locationName}</p></div>`);
                    layersRef.current.push(marker);
                });

                // GPX Waypoints
                GPX_WAYPOINTS.forEach(wpt => {
                    const circleMarker = L.circleMarker([wpt.lat, wpt.lng], {
                        radius: 6,
                        fillColor: "#991B1B",
                        color: "#fff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    circleMarker.bindPopup(`<div style="font-family: 'Roboto Condensed', sans-serif; font-size: 12px; font-weight: bold; color: #7f1d1d;">${wpt.name}</div>`);
                    layersRef.current.push(circleMarker);
                });

                // ROMAN Walk Track
                L.polyline(ROMAN_WALK_TRACK, { color: '#991B1B', weight: 4, opacity: 0.7, dashArray: '8, 12' }).addTo(map);
                
                if (userLocation) {
                    const uMarker = L.circleMarker([userLocation.lat, userLocation.lng], { radius: 8, color: 'white', weight: 3, fillColor: '#3b82f6', fillOpacity: 1 }).addTo(map);
                    layersRef.current.push(uMarker);
                }
            }, [activities, userLocation]);

            useEffect(() => {
                if (mapInstanceRef.current && focusedLocation) mapInstanceRef.current.flyTo([focusedLocation.lat, focusedLocation.lng], 16);
            }, [focusedLocation]);

            return <div ref={mapContainerRef} className="w-full h-full z-0" />;
        };

        const Budget = ({ itinerary }) => {
            const [currency, setCurrency] = useState('EUR');
            const total = itinerary.reduce((acc, curr) => acc + curr.priceEUR, 0);
            return (
                <div className="pb-24 px-4 pt-6 max-w-lg mx-auto h-full overflow-y-auto no-scrollbar">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-red-800 flex items-center"><Wallet className="mr-2" /> Presupuesto</h2></div>
                    <div className="bg-red-800 rounded-2xl p-6 text-white shadow-lg mb-8">
                        <p className="text-red-100 text-sm uppercase mb-1">Total Estimado</p>
                        <div className="text-4xl font-bold">€{total}</div>
                        <p className="text-xs mt-2 italic opacity-80">Incluye BIRG Ticket (12€) y otros buses.</p>
                    </div>
                    <div className="bg-white rounded-lg border shadow-sm divide-y">
                        {itinerary.filter(a => a.priceEUR > 0).map(act => (
                            <div key={act.id} className="p-4 flex justify-between">
                                <div><p className="text-sm font-bold">{act.title}</p><p className="text-xs text-gray-500 capitalize">{act.type}</p></div>
                                <div className="font-bold">€{act.priceEUR}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Guide = ({ userLocation }) => {
            const [playing, setPlaying] = useState(null);
            const [weather, setWeather] = useState(null);
            const [loadingWeather, setLoadingWeather] = useState(true);

            useEffect(() => {
                const fetchWeather = async () => {
                    try {
                        const response = await fetch(
                            'https://api.open-meteo.com/v1/forecast?latitude=41.89&longitude=12.49&hourly=temperature_2m,weathercode&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Europe%2FRome'
                        );
                        const data = await response.json();
                        setWeather(data);
                    } catch (e) { console.error(e); }
                    finally { setLoadingWeather(false); }
                };
                fetchWeather();
            }, []);

            const getWeatherIcon = (code, size = 20) => {
                if (code <= 1) return <Sun size={size} className="text-amber-500" />;
                if (code <= 3) return <Cloud size={size} className="text-slate-400" />;
                if (code <= 67) return <CloudRain size={size} className="text-blue-500" />;
                if (code <= 99) return <CloudLightning size={size} className="text-purple-500" />;
                return <Sun size={size} className="text-amber-500" />;
            };

            const play = (word) => {
                const ut = new SpeechSynthesisUtterance(word);
                ut.lang = 'it-IT';
                ut.onend = () => setPlaying(null);
                setPlaying(word);
                window.speechSynthesis.speak(ut);
            };

            const handleSOS = () => {
                const msg = `¡SOS! Necesito ayuda en Roma. Ubicación: ${userLocation ? `https://maps.google.com/?q=${userLocation.lat},${userLocation.lng}` : 'GPS no disponible'}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
            };

            return (
                <div className="pb-32 px-4 pt-6 max-w-lg mx-auto h-full overflow-y-auto no-scrollbar">
                    <h2 className="text-2xl font-bold text-red-800 mb-6 uppercase tracking-tight">Guía Roma</h2>
                    
                    {/* SOS WHATSAPP */}
                    <div className="mb-8 bg-red-600 rounded-[2rem] p-6 shadow-xl text-white relative overflow-hidden">
                        <div className="absolute top-[-20px] right-[-20px] w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                        <div className="relative z-10">
                            <div className="flex items-center mb-3">
                                <PhoneCall size={24} className="mr-3 animate-pulse" />
                                <h3 className="font-black text-lg uppercase tracking-widest">SOS WHATSAPP</h3>
                            </div>
                            <p className="text-xs text-red-100 mb-6 leading-relaxed">Envía tu ubicación exacta si necesitas asistencia inmediata o te has desorientado.</p>
                            <button onClick={handleSOS} className="w-full py-4 bg-white text-red-700 font-black rounded-2xl text-sm uppercase tracking-widest shadow-lg active:scale-95 transition-transform">Enviar SOS</button>
                        </div>
                    </div>

                    {/* WEATHER SECTION */}
                    <div className="mb-8">
                        <div className="flex items-center justify-between mb-4 px-1">
                            <h3 className="text-lg font-bold text-slate-800 flex items-center uppercase tracking-widest">
                                <Thermometer size={20} className="mr-2.5 text-red-600"/> Tiempo en Roma
                            </h3>
                            {!loadingWeather && <div className="flex items-center gap-1 text-[8px] font-black text-slate-400 uppercase tracking-tighter bg-slate-100 px-2 py-0.5 rounded-full">
                                <ArrowRight size={10} className="animate-bounce-x" /> DESLIZA
                            </div>}
                        </div>
                        
                        {loadingWeather ? (
                            <div className="p-8 text-center bg-white rounded-3xl border border-slate-100">
                                <div className="w-6 h-6 border-2 border-red-600 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                                <p className="text-xs font-bold text-slate-400 uppercase">Obteniendo datos...</p>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {/* Hourly Forecast with Robust Scroll View */}
                                <div className="bg-white p-2 pb-4 rounded-[2.5rem] border border-slate-100 shadow-lg relative overflow-hidden">
                                    <div className="absolute left-0 top-0 bottom-0 w-8 bg-gradient-to-r from-white to-transparent z-10 pointer-events-none"></div>
                                    <div className="absolute right-0 top-0 bottom-0 w-8 bg-gradient-to-l from-white to-transparent z-10 pointer-events-none"></div>
                                    
                                    <div className="flex overflow-x-auto custom-h-scrollbar gap-3 px-6 py-4 items-stretch">
                                        {weather.hourly.time.map((time, i) => {
                                            const h = new Date(time).getHours();
                                            if (h >= 7 && h <= 19) return (
                                                <div key={time} className="flex flex-col items-center justify-between min-w-[70px] p-3 bg-slate-50/80 rounded-3xl border border-slate-100 shadow-sm transition-all hover:bg-white active:scale-95">
                                                    <span className="text-[10px] font-black text-slate-400 mb-2 uppercase tracking-tighter">{h}:00</span>
                                                    <div className="p-2 bg-white rounded-2xl mb-2 flex items-center justify-center shadow-sm">
                                                        {getWeatherIcon(weather.hourly.weathercode[i], 28)}
                                                    </div>
                                                    <span className="text-base font-black text-slate-800 tracking-tighter">{Math.round(weather.hourly.temperature_2m[i])}°</span>
                                                </div>
                                            );
                                            return null;
                                        })}
                                    </div>
                                    <div className="mt-1 flex justify-center items-center gap-2">
                                        <div className="h-1 w-8 bg-slate-100 rounded-full"></div>
                                        <span className="text-[7px] font-black text-slate-300 uppercase tracking-[0.3em]">Pronóstico por horas</span>
                                        <div className="h-1 w-8 bg-slate-100 rounded-full"></div>
                                    </div>
                                </div>

                                {/* 5-Day Summary */}
                                <div className="bg-white rounded-[2rem] border border-slate-100 shadow-md divide-y divide-slate-50 overflow-hidden">
                                    <div className="p-4 bg-slate-50/50 flex items-center justify-between">
                                        <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-2">
                                            <Calendar size={14} className="text-red-700" /> Próximos 5 días
                                        </p>
                                    </div>
                                    {weather.daily.time.slice(0,5).map((date, i) => (
                                        <div key={date} className="flex items-center justify-between p-4 hover:bg-slate-50/30 transition-colors">
                                            <span className="text-xs font-black text-red-800 uppercase w-12">{new Date(date).toLocaleDateString('es-ES', {weekday: 'short'})}</span>
                                            <div className="flex-1 flex justify-center">
                                                {getWeatherIcon(weather.daily.weathercode[i], 20)}
                                            </div>
                                            <div className="flex gap-3 w-20 justify-end text-sm font-black">
                                                <span className="text-slate-800">{Math.round(weather.daily.temperature_2m_max[i])}°</span>
                                                <span className="text-slate-400 font-medium">{Math.round(weather.daily.temperature_2m_min[i])}°</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>

                    <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center uppercase tracking-widest px-1">
                        <Languages size={20} className="mr-2.5 text-red-600"/> Italiano Básico
                    </h3>
                    <div className="bg-white rounded-3xl shadow-md border border-slate-100 overflow-hidden mb-12">
                        {PRONUNCIATIONS.map((item, idx) => (
                            <div key={idx} className="p-5 flex justify-between items-center border-b last:border-0 hover:bg-slate-50/50 transition-colors group">
                                <div>
                                    <div className="flex items-center gap-3">
                                        <p className="font-black text-red-900 text-lg tracking-tight">{item.word}</p>
                                        <button 
                                            onClick={() => play(item.word)} 
                                            className={`p-2 rounded-full transition-all active:scale-90 ${playing === item.word ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-400 group-hover:bg-red-50 group-hover:text-red-300'}`}
                                        >
                                            <Volume2 size={16} className={playing === item.word ? 'animate-pulse' : ''} />
                                        </button>
                                    </div>
                                    <p className="text-xs text-slate-500 italic mt-1 font-medium tracking-tight">"{item.simplified}"</p>
                                </div>
                                <div className="text-right ml-4">
                                    <p className="text-[10px] font-black text-slate-500 bg-slate-100 px-3 py-1 rounded-full uppercase border border-slate-200 tracking-tighter">{item.meaning}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [itinerary, setItinerary] = useState(INITIAL_ITINERARY);
            const [activeTab, setActiveTab] = useState('timeline');
            const [userLocation, setUserLocation] = useState(null);
            const [mapFocus, setMapFocus] = useState(null);
            const [countdown, setCountdown] = useState('--h --m --s');
            const [audioActivity, setAudioActivity] = useState(null);
            const [isPlaying, setIsPlaying] = useState(false);

            useEffect(() => {
                const timer = setInterval(() => {
                    const now = new Date();
                    const [h, m] = SHIP_ONBOARD_TIME.split(':').map(Number);
                    const target = new Date();
                    target.setHours(h, m, 0, 0);
                    const diff = target.getTime() - now.getTime();
                    if (diff <= 0) setCountdown("¡A BORDO!");
                    else {
                        const hr = Math.floor(diff / 3600000);
                        const mn = Math.floor((diff % 3600000) / 60000);
                        const sc = Math.floor((diff % 60000) / 1000);
                        setCountdown(`${hr.toString().padStart(2,'0')}h ${mn.toString().padStart(2,'0')}m ${sc.toString().padStart(2,'0')}s`);
                    }
                }, 1000);
                if (navigator.geolocation) navigator.geolocation.watchPosition(pos => setUserLocation({ lat: pos.coords.latitude, lng: pos.coords.longitude }));
                setTimeout(() => { const l = document.getElementById('initial-loader'); if(l) l.style.opacity = '0', setTimeout(() => l.remove(), 400); }, 1000);
                return () => clearInterval(timer);
            }, []);

            return (
                <div className="flex flex-col h-screen bg-slate-50 overflow-hidden">
                    <header className="bg-red-950 text-white p-4 shadow-xl z-20 flex justify-between items-center shrink-0">
                        <div className="flex items-center"><Anchor className="mr-3 text-red-500" size={24} /><div><h1 className="font-black text-[10px] uppercase tracking-[0.2em] text-red-400">Escala Roma</h1><p className="text-[12px] font-bold text-white/90 leading-tight">16 Abril 2026</p></div></div>
                        <div className="text-right shrink-0">
                            <span className="text-[8px] font-black uppercase text-red-500 tracking-widest block mb-0.5">Cuenta atrás</span>
                            <div className="text-lg font-black font-mono text-red-400 leading-none">{countdown}</div>
                        </div>
                    </header>
                    <main className="flex-1 relative overflow-hidden">
                        {activeTab === 'timeline' && <div className="h-full overflow-y-auto no-scrollbar"><Timeline itinerary={itinerary} onToggleComplete={(id) => setItinerary(itinerary.map(a => a.id === id ? {...a, completed: !a.completed} : a))} onLocate={c => {setMapFocus(c); setActiveTab('map');}} userLocation={userLocation} onOpenAudioGuide={setAudioActivity} /></div>}
                        {activeTab === 'map' && <MapComponent activities={itinerary} userLocation={userLocation} focusedLocation={mapFocus} />}
                        {activeTab === 'budget' && <Budget itinerary={itinerary} />}
                        {activeTab === 'guide' && <Guide userLocation={userLocation} />}
                    </main>
                    {audioActivity && (
                      <div className="fixed inset-0 z-[100] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
                        <div className="bg-white rounded-[2.5rem] w-full max-w-lg overflow-hidden flex flex-col max-h-[85vh] shadow-2xl border-4 border-white/20">
                          <div className="p-6 bg-red-950 text-white flex justify-between items-center shrink-0">
                            <div className="flex items-center gap-3"><Headphones size={24} className="text-red-400"/><h2 className="font-bold text-lg leading-tight">{audioActivity.title}</h2></div>
                            <button onClick={() => { window.speechSynthesis.cancel(); setAudioActivity(null); setIsPlaying(false); }} className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition-colors"><X size={20}/></button>
                          </div>
                          <div className="p-8 overflow-y-auto text-sm italic text-slate-700 leading-relaxed font-medium">"{audioActivity.audioGuideText}"</div>
                          <div className="p-8 bg-slate-50 flex items-center gap-6 shrink-0">
                            <button onClick={() => { 
                                if (isPlaying) { window.speechSynthesis.cancel(); setIsPlaying(false); }
                                else { 
                                    const ut = new SpeechSynthesisUtterance(audioActivity.audioGuideText);
                                    ut.lang = 'es-ES'; ut.onend = () => setIsPlaying(false);
                                    window.speechSynthesis.speak(ut); setIsPlaying(true);
                                }
                            }} className={`w-16 h-16 rounded-full flex items-center justify-center shadow-xl transition-all active:scale-90 ${isPlaying ? 'bg-red-100 text-red-600' : 'bg-red-800 text-white'}`}>
                                {isPlaying ? <Square size={24} fill="currentColor"/> : <Play size={24} fill="currentColor" className="ml-1" />}
                            </button>
                            <p className="text-[10px] font-black uppercase text-slate-400 tracking-[0.2em]">{isPlaying ? 'Reproduciendo audio...' : 'Pulsa para reproducir'}</p>
                          </div>
                        </div>
                      </div>
                    )}
                    <nav className="bg-white border-t h-20 flex justify-around items-center px-2 pb-safe shrink-0 shadow-[0_-4px_20px_rgba(0,0,0,0.03)] z-30">
                        {[
                          { id: 'timeline', icon: CalendarClock, label: 'Itinerario' },
                          { id: 'map', icon: MapIcon, label: 'Mapa' },
                          { id: 'budget', icon: Wallet, label: 'Gastos' },
                          { id: 'guide', icon: BookOpen, label: 'Guía' }
                        ].map(t => (
                          <button key={t.id} onClick={() => setActiveTab(t.id)} className={`flex flex-col items-center w-full transition-colors ${activeTab === t.id ? 'text-red-800' : 'text-slate-300'}`}>
                            <div className={`p-2 rounded-2xl mb-1 ${activeTab === t.id ? 'bg-red-50 shadow-sm' : ''}`}><t.icon size={22} /></div>
                            <span className={`text-[9px] font-black uppercase tracking-[0.1em] ${activeTab === t.id ? 'opacity-100' : 'opacity-60'}`}>{t.label}</span>
                          </button>
                        ))}
                    </nav>
                </div>
            );
        };

        createRoot(document.getElementById('root')).render(<App />);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js');
            });
        }
    </script>
</body>
</html>